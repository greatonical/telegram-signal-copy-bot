name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        env:
          ENV_CONTENT: ${{ secrets.ENV_FILE }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_PORT }}
          envs: ENV_CONTENT
          script: |
            # Create app directory if it doesn't exist
            mkdir -p /root/telegram-signal-copy-bot
            cd /root/telegram-signal-copy-bot

            # Clone or pull latest code
            if [ -d ".git" ]; then
              echo "Updating existing repository..."
              git fetch origin
              git reset --hard origin/main
            else
              echo "Cloning repository..."
              # Remove the directory and clone fresh
              cd /root
              rm -rf telegram-signal-copy-bot
              git clone https://github.com/${{ github.repository }}.git
              cd telegram-signal-copy-bot
            fi

            # Make deploy script executable
            chmod +x deploy.sh

            # Run deployment script
            export ENV_CONTENT="${ENV_CONTENT}"
            ./deploy.sh

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "Checking container status..."
            docker ps | grep telegram-bot

            echo ""
            echo "Recent logs:"
            docker logs --tail 30 telegram-bot
